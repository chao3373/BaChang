<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>订单追踪</title>
    <link rel="stylesheet" type="text/css" href="/static/jquery-easyui-1.3.3/themes/bootstrap/easyui.css"></link>
    <link rel="stylesheet" type="text/css"
          href="/static/jquery-easyui-1.3.3/themes/icon.css"></link>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/jquery.min.js"></script>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/jquery.easyui.min.js"></script>
    <script type="text/javascript"
            src="/static/jquery-easyui-1.3.3/locale/easyui-lang-zh_CN.js"></script>
    <script type="text/javascript" src="/static/js/date.js"></script>
    <script type="text/javascript">

        $(document).ready(function () {

            $("#dg").datagrid({
                columns: [[
                    {
                        field: 'id',
                        title: '编号',
                        width: 100,
                        align: 'center',
                        hidden: 'true'
                    }, {
                        field: 'clientname',
                        title: '客户名称',
                        width: 130,
                        align: 'center',

                    }, {
                        field: 'name',
                        title: '产品名称',
                        width: 130,
                        align: 'center'
                    }, {
                        field: 'length',
                        title: '长度',
                        width: 130,
                        align: 'center'
                    }, {
                        field: 'num',
                        title: '总数量',
                        width: 130,
                        align: 'center'
                    }, {
                        field: 'model',
                        title: '宽',
                        width: 130,
                        align: 'center'
                    }, {
                        field: 'realityweight',
                        title: '实际重量',
                        width: 130,
                        align: 'center'
                    },
                    // }, {
                    //     field: 'saleDate',
                    //     title: '销售日期',
                    //     width: 130,
                    //     align: 'center',
                    //     formatter: function (value, row) {
                    //         if (row.saleList) {
                    //            // return row.saleList.saleDate;
                    //             var date = new Date(row.saleList.saleDate);
                    //             var m = date.getMonth() > 10 ? date.getMonth() : "0" + date.getMonth();
                    //             var d = date.getDay() > 10 ? date.getDay() : "0" + date.getDay();
                    //             return (date.getFullYear() + "-" + m + "-" + d);
                    //         }
                    //         return "";
                    //     }
                    // },
                    {
                        field: 'dateInProduced',
                        title: '生产日期',
                        width: 130,
                        align: 'center'
                    }]]

            });
        });


        //导出
        function daochu(dg) {
            var fields = $("#dg").datagrid('getColumnFields');
            var datagridTitle = new Array();
            for (var i = 0; i < fields.length; i++) {
                var option = $("#dg").datagrid('getColumnOption', fields[i]);
                if (option.field != "checkItem" && option.hidden != "true") { //过滤勾选框和隐藏列
                    var obj = {};
                    obj.title = option.title;
                    obj.field = option.field;
                    if (option.formatter) {
                        obj.formatter = option.formatter;
                    }
                    datagridTitle.push(obj);
                }
            }
            console.log(datagridTitle);

            var jsonarr = [];
            var rows = $(dg).datagrid("getRows");
            for (let i = 0; i < rows.length; i++) {
                var json = {};
                console.log(rows[i]);
                for (let j = 0; j < datagridTitle.length; j++) {
                    var st = datagridTitle[j].title;
                    if (datagridTitle[j].formatter) {
                        json[datagridTitle[j].title] = datagridTitle[j].formatter(rows[datagridTitle[j].field], rows[i]);
                    } else {
                        json[datagridTitle[j].title] = rows[i][datagridTitle[j].field];
                    }
                }
                console.log(JSON.stringify(json));
                jsonarr.push(JSON.stringify(json));
            }

            jsonarr = "[" + jsonarr.join(",") + "]";
            console.log(jsonarr);
            alert(jsonarr);

            $.ajax({
                type: "POST",
                url: "/admin/daochu?title=订单追踪",
                data: {a: jsonarr},
                success: function (result) {
                    if (result.success) {
                        $.messager.alert("系统提示", "导出成功");
                    }
                    return;
                }
            });

        }


        function screenSale() {
            var salenumber = $("#saleNumber").val();
            if (salenumber == "") {
                $.messager.alert("系统提示", "请输入订单号！");
                return;
            }
            $.post("/admin/storage/findSaleListId", {
                saleNumber: salenumber
            }, function (result) {
                console.log(result);
                $("#dg").datagrid("loadData", result.rows);
            }, "json");
        }

        //刷新筛选条件,并初始化筛选属性的值
        function clertCondition() {
            /*loadData();
            json = {};
            $("#jitai").combobox("reset");
            $("#productDate").datebox("reset");
            $("#group").combobox("reset");*/
            window.location.reload();
        }

        //按照条件筛选订单信息
        function screenSale() {
            addScreen();
            refreshData();

            var sumweight=0;
            var sumnum=0;
            var a = $("#dg").datagrid("getRows");
            for(var i=0;i<a.length;i++){
                sumweight+=a[i].realityweight;
                sumnum+=a[i].num;
            }
            $("#sumnum").val(sumnum);
            $("#sumweight").val(sumweight);
        }

        //添加筛选条件
        function addScreen() {
            json = {};
            /*if ($("#saleNumber").val()) {
                json.saleNumber = $("#saleNumber").val();
            }*/
            if ($("#productDate").datebox("getText")) {
                json.productDate = $("#productDate").datebox("getText");
            }
            if ($("#group").combobox("getValue")) {
                json.group = $("#group").combobox("getValue");
            }
            if ($("#jitai").combobox("getValue")) {
                json.jitai = $("#jitai").combobox("getValue");
            }
            console.log(json);
        }


        //添加条件筛选时刷新数据
        function refreshData() {
            $.ajax({
                type: "POST",
                async: false,
                url: "/admin/storage/JitaiProduct", json,
                success: function (result) {
                    if (result.success) {
                        $("#dg").datagrid('loadData', result.rows);
                    }
                }
            });
        }


    </script>
</head>
<body style="margin: 1px" class="easyui-layout">
<div data-options="region:'center'" style="padding: 10px; border: 1px;">
    <table id="dg" class="easyui-datagrid"
           rownumbers="true" singleSelect="true"
           toolbar="#tb" fit="true">
    </table>


    <div id="tb" style="padding: 15px;">
        <table>
            <tr>
                <td>生产日期：<input
                        type="text" id="productDate" name="productDate" class="easyui-datebox"
                        demandd="true" data-options="editable:false" size="15"/>
                </td>
                <td>&nbsp;&nbsp;机台：<input
                        class="easyui-combobox" id="jitai" name="jitai"
                        style="width: 100px"
                        data-options="panelHeight:'auto',valueField:'id',textField:'name',url:'/admin/jitai/jitaiList'"/>
                </td>
                <td>&nbsp;&nbsp;班组：<input
                        class="easyui-combobox" id="group" name="group"
                        style="width: 100px"
                        data-options="panelHeight:'auto',valueField:'id',textField:'name',url:'/admin/group/groupList'"/>
                </td>
                <td> &nbsp;&nbsp;<a href="javascript:screenSale()"
                                    class="easyui-linkbutton" iconCls="icon-search">查询</a>
                </td>
                <td>&nbsp;&nbsp; <a href="javascript:clertCondition()" class="easyui-linkbutton"
                                    iconCls="icon-reload">刷新</a>
                </td>
                <td>
                    &nbsp;&nbsp;合计重量:&nbsp;<input id="sumweight" name="sumweight" style="width: 100px"
                                                                    readonly/>
                </td>
                <td>
                   &nbsp;&nbsp;合计数量:&nbsp;<input id="sumnum" name="sumnum" style="width: 100px"
                                                                    readonly/>
                </td>
            </tr>
        </table>
    </div>
</div>
</body>
</html>